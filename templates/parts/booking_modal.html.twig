<!-- Booking Modal Overlay -->
<div id="bookingModal" class="fixed inset-0 bg-black/70 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0" id="bookingContent">

        <!-- Header -->
        <div class="bg-gray-900 px-6 py-4 flex justify-between items-center text-white">
            <h3 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-calendar-alt text-pink-500"></i> Ամրագրել Այց
            </h3>
            <button onclick="closeBooking()" class="text-gray-400 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Body -->
        <div class="p-6 max-h-[80vh] overflow-y-auto">
            <form id="bookingForm" onsubmit="submitBooking(event)">

                <!-- Step 1: Service (global booking flow) -->
                <div class="mb-5" id="stepService">
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. Ընտրեք Ծառայությունը</label>
                    <div class="relative">
                        <select id="serviceSelect"
                                required
                                class="w-full appearance-none border border-gray-300 rounded-lg bg-white px-3 py-2.5 pr-10 text-left shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                onchange="onServiceChange()">
                            <option value="">-- Ընտրել --</option>
                            {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }} ({{ service.price }} AMD)</option>
                            {% endfor %}
                        </select>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </span>
                    </div>
                </div>

                <!-- Step 2: Artist -->
                <div class="mb-5 opacity-50 pointer-events-none transition-all" id="stepArtist">
                    <label class="block text-sm font-bold text-gray-700 mb-2">2. Ընտրեք Վարպետին</label>
                    <div class="relative">
                        <select id="artistSelect"
                                required
                                class="w-full appearance-none border border-gray-300 rounded-lg bg-white px-3 py-2.5 pr-10 text-left shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                onchange="onArtistChange()">
                            <option value="">-- Նախ ընտրեք ծառայությունը --</option>
                        </select>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </span>
                    </div>
                </div>

                <!-- Step 3: Date -->
                <div class="mb-5 opacity-50 pointer-events-none transition-all" id="stepDate">
                    <label class="block text-sm font-bold text-gray-700 mb-2">3. Ընտրեք Օրը</label>
                    <input type="date" id="dateInput" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2.5 bg-gray-50 border" onchange="loadSlots()">
                </div>

                <!-- Step 4: Time Slots -->
                <div class="mb-5 hidden" id="stepSlots">
                    <label class="block text-sm font-bold text-gray-700 mb-2">4. Ազատ Ժամեր</label>
                    <div id="slotsContainer" class="grid grid-cols-4 gap-2">
                        <!-- Slots will be injected here via JS -->
                    </div>
                    <input type="hidden" id="selectedTime" required>
                </div>

                <!-- Step 5: Client Info -->
                <div class="mb-5 hidden space-y-3" id="stepClient">
                    <hr class="border-gray-200">
                    <h4 class="font-bold text-pink-600">Ձեր Տվյալները</h4>
                    <input type="text" id="clientName" placeholder="Ձեր Անունը" required class="w-full rounded-lg border-gray-300 p-2 border">
                    <input type="tel" id="clientPhone" placeholder="Հեռախոս" required class="w-full rounded-lg border-gray-300 p-2 border">
                    <input type="email" id="clientEmail" placeholder="Email (կամայական)" class="w-full rounded-lg border-gray-300 p-2 border">

                    <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                        Հաստատել Ամրագրումը
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    // --- UI LOGIC ---
    window.__bookingMode = 'global'; // 'global' | 'artist'
    window.__bookingAllServicesOptions = null;
    window.__bookingArtistsCache = null; // cached from /api/booking/artists

    function initBookingCaches() {
        const serviceSelect = document.getElementById('serviceSelect');
        if (serviceSelect && window.__bookingAllServicesOptions === null) {
            window.__bookingAllServicesOptions = serviceSelect.innerHTML;
        }
    }

    function openBooking(options = {}) {
        const modal = document.getElementById('bookingModal');
        const content = document.getElementById('bookingContent');
        modal.classList.remove('hidden');
        // Small delay for animation
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);

        initBookingCaches();

        const artistId = options && options.artistId ? String(options.artistId) : null;
        window.__bookingMode = artistId ? 'artist' : 'global';

        resetBookingFormState();

        if (artistId) {
            // Artist-specific booking: artist is locked, services are filtered by artist
            setArtistLocked(artistId);
            loadServicesForArtist(artistId);
        }
    }

    function closeBooking() {
        const modal = document.getElementById('bookingModal');
        const content = document.getElementById('bookingContent');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // --- API LOGIC ---
    function resetBookingFormState() {
        const artistSelect = document.getElementById('artistSelect');
        const serviceSelect = document.getElementById('serviceSelect');
        const dateInput = document.getElementById('dateInput');

        // restore service options for global mode
        if (serviceSelect && window.__bookingAllServicesOptions !== null) {
            serviceSelect.innerHTML = window.__bookingAllServicesOptions;
            serviceSelect.value = '';
        }

        if (artistSelect) {
            artistSelect.disabled = false;
            artistSelect.value = '';
            artistSelect.innerHTML = '<option value="">-- Նախ ընտրեք ծառայությունը --</option>';
        }

        if (dateInput) dateInput.value = '';

        // steps
        document.getElementById('stepService')?.classList.remove('opacity-50', 'pointer-events-none');
        document.getElementById('stepArtist')?.classList.add('opacity-50', 'pointer-events-none');
        document.getElementById('stepDate')?.classList.add('opacity-50', 'pointer-events-none');
        document.getElementById('stepSlots')?.classList.add('hidden');
        document.getElementById('stepClient')?.classList.add('hidden');
        const selectedTime = document.getElementById('selectedTime');
        if (selectedTime) selectedTime.value = '';
    }

    async function ensureArtistsCache() {
        if (window.__bookingArtistsCache) return window.__bookingArtistsCache;
        const response = await fetch('/api/booking/artists');
        const artists = await response.json();
        window.__bookingArtistsCache = Array.isArray(artists) ? artists : [];
        return window.__bookingArtistsCache;
    }

    async function setArtistLocked(artistId) {
        const artistSelect = document.getElementById('artistSelect');
        const stepArtist = document.getElementById('stepArtist');
        if (!artistSelect || !stepArtist) return;

        artistSelect.disabled = true;
        artistSelect.innerHTML = `<option value="${artistId}">Բեռնվում է...</option>`;
        artistSelect.value = artistId;
        stepArtist.classList.remove('opacity-50', 'pointer-events-none');

        try {
            const artists = await ensureArtistsCache();
            const found = artists.find(a => String(a.id) === String(artistId));
            artistSelect.innerHTML = `<option value="${artistId}">${found ? found.name : ('Artist #' + artistId)}</option>`;
            artistSelect.value = artistId;
        } catch (e) {
            artistSelect.innerHTML = `<option value="${artistId}">Artist #${artistId}</option>`;
            artistSelect.value = artistId;
        }
    }

    async function loadServicesForArtist(artistId) {
        const serviceSelect = document.getElementById('serviceSelect');
        if (!serviceSelect) return;

        serviceSelect.innerHTML = '<option value="">Բեռնվում է...</option>';
        serviceSelect.value = '';

        try {
            const response = await fetch(`/api/booking/services/${artistId}`);
            const services = await response.json();
            serviceSelect.innerHTML = '<option value="">-- Ընտրել --</option>';
            (Array.isArray(services) ? services : []).forEach(service => {
                serviceSelect.innerHTML += `<option value="${service.id}">${service.name} (${service.price} AMD)</option>`;
            });

            // If only one service, auto-select it
            const opts = Array.from(serviceSelect.options).filter(o => o.value);
            if (opts.length === 1) {
                serviceSelect.value = opts[0].value;
                enableDate();
            }
        } catch (e) {
            console.error('Error:', e);
            serviceSelect.innerHTML = '<option value="">Չհաջողվեց բեռնել ծառայությունները</option>';
        }
    }

    async function loadArtistsByService(serviceId) {
        const artistSelect = document.getElementById('artistSelect');
        const stepArtist = document.getElementById('stepArtist');
        if (!artistSelect || !stepArtist) return;

        artistSelect.disabled = false;
        artistSelect.innerHTML = '<option value="">Բեռնվում է...</option>';
        artistSelect.value = '';

        try {
            const response = await fetch(`/api/booking/artists/${serviceId}`);
            const artists = await response.json();
            artistSelect.innerHTML = '<option value="">-- Ընտրել --</option>';
            (Array.isArray(artists) ? artists : []).forEach(artist => {
                artistSelect.innerHTML += `<option value="${artist.id}">${artist.name}</option>`;
            });
            stepArtist.classList.remove('opacity-50', 'pointer-events-none');
        } catch (e) {
            console.error('Error:', e);
            artistSelect.innerHTML = '<option value="">Չհաջողվեց բեռնել վարպետներին</option>';
        }
    }

    function onServiceChange() {
        const serviceId = document.getElementById('serviceSelect')?.value;

        // reset downstream
        document.getElementById('stepDate')?.classList.add('opacity-50', 'pointer-events-none');
        document.getElementById('stepSlots')?.classList.add('hidden');
        document.getElementById('stepClient')?.classList.add('hidden');
        const selectedTime = document.getElementById('selectedTime');
        if (selectedTime) selectedTime.value = '';

        if (!serviceId) {
            document.getElementById('stepArtist')?.classList.add('opacity-50', 'pointer-events-none');
            const artistSelect = document.getElementById('artistSelect');
            if (artistSelect) {
                artistSelect.disabled = (window.__bookingMode === 'artist');
                artistSelect.value = '';
                if (window.__bookingMode === 'global') {
                    artistSelect.innerHTML = '<option value="">-- Նախ ընտրեք ծառայությունը --</option>';
                }
            }
            return;
        }

        if (window.__bookingMode === 'global') {
            loadArtistsByService(serviceId);
        } else {
            // artist mode: artist already selected, just enable date when both chosen
            enableDate();
        }
    }

    function onArtistChange() {
        // reset downstream
        document.getElementById('stepSlots')?.classList.add('hidden');
        document.getElementById('stepClient')?.classList.add('hidden');
        const selectedTime = document.getElementById('selectedTime');
        if (selectedTime) selectedTime.value = '';

        enableDate();
    }

    function enableDate() {
        const serviceId = document.getElementById('serviceSelect')?.value;
        const artistId = document.getElementById('artistSelect')?.value;
        const stepDate = document.getElementById('stepDate');

        if (serviceId && artistId) {
            stepDate?.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            stepDate?.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    async function loadSlots() {
        const artistId = document.getElementById('artistSelect').value;
        const serviceId = document.getElementById('serviceSelect').value;
        const date = document.getElementById('dateInput').value;
        const slotsContainer = document.getElementById('slotsContainer');
        const stepSlots = document.getElementById('stepSlots');

        if(!artistId || !serviceId || !date) return;

        slotsContainer.innerHTML = '<p class="col-span-4 text-center text-gray-500">Բեռնվում է...</p>';
        stepSlots.classList.remove('hidden');

        try {
            const url = `/api/booking/slots?artistId=${artistId}&serviceId=${serviceId}&date=${date}`;
            const response = await fetch(url);
            const data = await response.json();

            slotsContainer.innerHTML = '';

            if (data.slots.length === 0) {
                slotsContainer.innerHTML = '<p class="col-span-4 text-center text-red-500">Այս օրը ազատ տեղեր չկան:</p>';
                return;
            }

            data.slots.forEach(time => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'border border-pink-200 text-pink-600 hover:bg-pink-600 hover:text-white py-2 rounded transition text-sm font-bold';
                btn.innerText = time;
                btn.onclick = () => selectTime(btn, time);
                slotsContainer.appendChild(btn);
            });

        } catch (e) {
            console.error(e);
        }
    }

    function selectTime(btn, time) {
        // Remove active class from others
        document.querySelectorAll('#slotsContainer button').forEach(b => {
            b.classList.remove('bg-pink-600', 'text-white');
            b.classList.add('text-pink-600');
        });

        // Add active class
        btn.classList.remove('text-pink-600');
        btn.classList.add('bg-pink-600', 'text-white');

        document.getElementById('selectedTime').value = time;
        document.getElementById('stepClient').classList.remove('hidden');
    }

    async function submitBooking(e) {
        e.preventDefault();

        const data = {
            serviceId: document.getElementById('serviceSelect').value,
            artistId: document.getElementById('artistSelect').value,
            date: document.getElementById('dateInput').value,
            time: document.getElementById('selectedTime').value,
            name: document.getElementById('clientName').value,
            phone: document.getElementById('clientPhone').value,
            email: document.getElementById('clientEmail').value
        };

        try {
            const response = await fetch('/api/booking/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if(result.success) {
                alert('Շնորհավորում ենք! Ձեր ամրագրումը կատարված է: Շուտով կապ կհաստատենք:');
                location.reload();
            } else {
                alert('Սխալ: ' + JSON.stringify(result));
            }
        } catch (e) {
            alert('Համակարգային սխալ');
        }
    }
</script>