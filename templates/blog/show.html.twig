{% extends 'base.html.twig' %}

{% set __ango_og_type = 'article' %}
{% if post.imageUrl %}
    {% set __ango_og_image = absolute_url(asset('uploads/posts/' ~ post.imageUrl)) %}
    {% set __ango_og_image_alt = post.title %}
{% endif %}

{% block title %}{{ post.title }} | AnGo{% endblock %}
{% block meta_description %}{{ post.excerpt(160) }}{% endblock %}

{% block structured_data %}
    {{ parent() }}
    {% set __ango_json_opts = constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_UNESCAPED_UNICODE') %}
    {% set __ango_site_url = absolute_url(path('app_home')) %}
    {% set __page_url = absolute_url(app.request.pathinfo) %}
    {% set __author_name = (post.artist.user.firstName ~ ' ' ~ post.artist.user.lastName)|trim %}

    {% set __keywords = [] %}
    {% for s in post.services %}
        {% set __keywords = __keywords|merge([s.name]) %}
    {% endfor %}

    {% set __blog_post = {
        '@type': 'BlogPosting',
        '@id': __page_url ~ '#blogposting',
        'headline': post.title,
        'description': post.excerpt(180),
        'url': __page_url,
        'mainEntityOfPage': __page_url,
        'inLanguage': 'hy-AM',
        'author': {
            '@type': 'Person',
            'name': __author_name,
            'url': absolute_url(path('app_artist_show', {id: post.artist.id}))
        },
        'publisher': { '@id': __ango_site_url ~ '#organization' },
        'datePublished': (post.publishedAt ? post.publishedAt|date('c') : post.createdAt|date('c')),
        'dateModified': (post.updatedAt ? post.updatedAt|date('c') : (post.publishedAt ? post.publishedAt|date('c') : post.createdAt|date('c'))),
        'keywords': __keywords
    } %}
    {% if post.imageUrl %}
        {% set __blog_post = __blog_post|merge({'image': absolute_url(asset('uploads/posts/' ~ post.imageUrl))}) %}
    {% endif %}

    <script type="application/ld+json">
        {{ {
            '@context': 'https://schema.org',
            '@graph': [ __blog_post ]
        }|json_encode(__ango_json_opts)|raw }}
    </script>
{% endblock %}

{% block head_extra %}
    <meta property="article:published_time" content="{{ (post.publishedAt ? post.publishedAt|date('c') : post.createdAt|date('c')) }}">
    <meta property="article:modified_time" content="{{ (post.updatedAt ? post.updatedAt|date('c') : (post.publishedAt ? post.publishedAt|date('c') : post.createdAt|date('c'))) }}">
    <meta property="article:author" content="{{ absolute_url(path('app_artist_show', {id: post.artist.id})) }}">
{% endblock %}

{% block body %}
    <div class="bg-white">
        <div class="container mx-auto px-4 py-10">
            <div class="max-w-4xl mx-auto">
                <div class="mb-8">
                    <a href="{{ path('app_artist_show', {id: post.artist.id}) }}" class="text-sm text-gray-500 hover:text-pink-600 transition">
                        ← {{ post.artist.user.firstName }} {{ post.artist.user.lastName }}
                    </a>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mt-3">{{ post.title }}</h1>
                    <div class="flex flex-wrap items-center gap-2 mt-4">
                        {% for s in post.services %}
                            <a href="{{ path('app_blog_category', {category: s.category}) ~ '?service=' ~ s.id }}"
                               class="text-xs font-semibold bg-pink-50 text-pink-700 px-2 py-1 rounded-full border border-pink-100 hover:bg-pink-100 transition">
                                {{ s.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>

                {% if post.imageUrl %}
                    <div class="rounded-2xl overflow-hidden border bg-gray-100 mb-8">
                        <img src="{{ asset('uploads/posts/' ~ post.imageUrl) }}" alt="{{ post.title }}" class="w-full h-auto">
                    </div>
                {% endif %}

                <article class="prose max-w-none prose-p:leading-relaxed prose-a:text-pink-600">
                    {{ post.content|raw }}
                </article>

                <div class="mt-12 border-t pt-8">
                    {% set avg = ratingStats.avg|default(0) %}
                    {% set count = ratingStats.count|default(0) %}
                    {% set avgText = avg|number_format(1, '.', '') %}
                    {% set percent = (avg / 5 * 100) %}
                    {% set percent = percent < 0 ? 0 : (percent > 100 ? 100 : percent) %}

                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-5">
                        <h2 class="text-2xl font-bold">Գնահատական</h2>

                        {# Rating pill (number + stars) #}
                        <div id="ratingPill" class="inline-flex items-center gap-3 px-4 py-2 rounded-full border border-gray-200 bg-white shadow-sm relative">
                            <span id="ratingAvg" class="text-lg font-bold text-gray-900">{{ avgText }}</span>

                            <div class="relative leading-none" aria-label="{{ avgText }} / 5">
                                <div class="flex text-gray-200 text-lg">
                                    {% for i in 1..5 %}
                                        <i class="fas fa-star" aria-hidden="true"></i>
                                    {% endfor %}
                                </div>
                                <div id="ratingFill" class="absolute inset-0 overflow-hidden" data-percent="{{ percent }}">
                                    <div class="flex text-yellow-400 text-lg">
                                        {% for i in 1..5 %}
                                            <i class="fas fa-star" aria-hidden="true"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <span id="ratingCount" class="text-sm text-gray-500">({{ count }})</span>

                            <span id="ratingSavedIcon" aria-hidden="true">
                                <i class="fas fa-check" aria-hidden="true"></i>
                            </span>
                        </div>
                    </div>

                    {% if app.user %}
                        <div id="ratingAjaxMessage" class="hidden mb-3 rounded-xl border px-4 py-3 text-sm"></div>

                        <form id="ratingForm" method="post" action="{{ path('app_blog_rate', {id: post.id}) }}" class="flex flex-col gap-3">
                            <input type="hidden" name="_token" value="{{ csrf_token('blog_rate_' ~ post.id) }}">

                            <div class="flex items-center gap-3">
                                <div class="ango-star-rating text-2xl">
                                    {% for i in 5..1 %}
                                        <input type="radio"
                                               id="rate-{{ i }}"
                                               name="value"
                                               value="{{ i }}"
                                               {{ myRating == i ? 'checked' : '' }}>
                                        <label for="rate-{{ i }}" title="{{ i }} / 5" aria-label="{{ i }} / 5">
                                            <i class="fas fa-star" aria-hidden="true"></i>
                                        </label>
                                    {% endfor %}
                                </div>

                                <div class="text-xs text-gray-500">
                                    {{ count == 0 ? 'Դուք կարող եք լինել առաջինը' : 'Շնորհակալություն' }}
                                </div>
                            </div>
                        </form>
                    {% else %}
                        <a href="{{ path('app_login') }}" class="text-pink-600 font-semibold hover:underline">
                            Մուտք գործեք՝ գնահատելու համար
                        </a>
                    {% endif %}
                </div>

                <div class="mt-12 border-t pt-8">
                    <h2 class="text-2xl font-bold mb-4">Մեկնաբանություններ</h2>

                    {% if app.user %}
                        <div id="commentAjaxMessage" class="hidden mb-3 rounded-xl border px-4 py-3 text-sm"></div>

                        <form id="commentForm" method="post" action="{{ path('app_blog_comment', {id: post.id}) }}" class="mb-8">
                            <input type="hidden" name="_token" value="{{ csrf_token('blog_comment_' ~ post.id) }}">
                            <textarea id="commentBody" name="body" rows="4" class="w-full border rounded-xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-pink-200" placeholder="Գրեք ձեր կարծիքը..."></textarea>
                            <div class="flex justify-end mt-3">
                                <button id="commentSubmit" class="bg-gray-900 text-white px-6 py-2 rounded-lg text-sm font-semibold hover:bg-pink-600 transition">
                                    Ավելացնել
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <a href="{{ path('app_login') }}" class="text-pink-600 font-semibold hover:underline">
                            Մուտք գործեք՝ մեկնաբանելու համար
                        </a>
                    {% endif %}

                    <div id="commentsList" class="space-y-4">
                        {% if comments|length %}
                            {% for c in comments %}
                                <div class="bg-gray-50 border rounded-2xl p-5">
                                    <div class="flex items-center justify-between">
                                        <div class="font-bold text-gray-900 text-sm">
                                            {{ c.user.firstName }} {{ c.user.lastName }}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            {{ c.createdAt|date('Y-m-d H:i') }}
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-700 mt-2 whitespace-pre-line">{{ c.body }}</div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div id="noComments" class="text-gray-500">
                                Առաջինն եղեք, ով կթողնի մեկնաբանություն։
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        (function () {
            const loginUrl = {{ path('app_login')|json_encode|raw }};

            function setAjaxMessage(el, message, type) {
                if (!el) return;
                if (!message) {
                    el.classList.add('hidden');
                    el.textContent = '';
                    return;
                }

                el.classList.remove('hidden');
                el.classList.remove('bg-red-50', 'border-red-200', 'text-red-800', 'bg-green-50', 'border-green-200', 'text-green-800');

                if (type === 'success') {
                    el.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                } else {
                    el.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                }
                el.textContent = message;
            }

            function retrigger(el, className) {
                if (!el) return;
                el.classList.remove(className);
                // Force reflow so animation can replay
                void el.offsetWidth;
                el.classList.add(className);
            }

            async function postForm(url, params) {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: new URLSearchParams(params)
                });

                let data = null;
                try {
                    data = await response.json();
                } catch (e) {
                    data = null;
                }

                return {response, data};
            }

            // --- Rating AJAX ---
            const ratingForm = document.getElementById('ratingForm');
            if (ratingForm) {
                const ratingMsg = document.getElementById('ratingAjaxMessage');
                const ratingAvgEl = document.getElementById('ratingAvg');
                const ratingCountEl = document.getElementById('ratingCount');
                const ratingFillEl = document.getElementById('ratingFill');
                const ratingPill = document.getElementById('ratingPill');
                const ratingSavedIcon = document.getElementById('ratingSavedIcon');

                // Initial fill from server-rendered percent (avoid inline styles in Twig).
                if (ratingFillEl) {
                    const initial = Number(ratingFillEl.dataset.percent ?? 0);
                    const percent = Math.max(0, Math.min(100, initial));
                    ratingFillEl.style.width = percent.toFixed(2) + '%';
                }

                ratingForm.addEventListener('change', async (e) => {
                    const target = e.target;
                    if (!target || target.name !== 'value') return;

                    setAjaxMessage(ratingMsg, '', 'success');

                    const token = ratingForm.querySelector('input[name="_token"]')?.value || '';
                    const value = String(target.value || '');
                    if (!value) return;

                    // Optimistic: disable inputs while saving
                    const inputs = Array.from(ratingForm.querySelectorAll('input[name="value"]'));
                    inputs.forEach(i => i.disabled = true);

                    try {
                        const {response, data} = await postForm(ratingForm.action, {_token: token, value});

                        if (response.status === 401 || response.status === 403) {
                            window.location.href = loginUrl;
                            return;
                        }

                        if (!response.ok || !data || data.success !== true) {
                            setAjaxMessage(ratingMsg, (data && data.error) ? data.error : 'Չհաջողվեց պահպանել գնահատականը։', 'error');
                            return;
                        }

                        const avg = Number(data.avg ?? 0);
                        const count = Number(data.count ?? 0);

                        if (ratingAvgEl) ratingAvgEl.textContent = avg.toFixed(1);
                        if (ratingCountEl) ratingCountEl.textContent = '(' + String(count) + ')';
                        if (ratingFillEl) {
                            const percent = Math.max(0, Math.min(100, (avg / 5) * 100));
                            ratingFillEl.style.width = percent.toFixed(2) + '%';
                        }

                        // Success effect (no reload)
                        retrigger(ratingPill, 'ango-rate-pop');
                        retrigger(ratingSavedIcon, 'ango-rate-saved');

                        setTimeout(() => setAjaxMessage(ratingMsg, '', 'success'), 1500);
                    } catch (err) {
                        setAjaxMessage(ratingMsg, 'Համակարգային սխալ։', 'error');
                    } finally {
                        inputs.forEach(i => i.disabled = false);
                    }
                });
            }

            // --- Comment AJAX ---
            const commentForm = document.getElementById('commentForm');
            if (commentForm) {
                const commentMsg = document.getElementById('commentAjaxMessage');
                const commentBody = document.getElementById('commentBody');
                const commentSubmit = document.getElementById('commentSubmit');
                const commentsList = document.getElementById('commentsList');

                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    setAjaxMessage(commentMsg, '', 'success');

                    const token = commentForm.querySelector('input[name="_token"]')?.value || '';
                    const body = (commentBody && commentBody.value) ? commentBody.value.trim() : '';
                    if (body.length < 3) {
                        setAjaxMessage(commentMsg, 'Մեկնաբանությունը պետք է լինի առնվազն 3 նիշ։', 'error');
                        return;
                    }

                    if (commentSubmit) commentSubmit.disabled = true;

                    try {
                        const {response, data} = await postForm(commentForm.action, {_token: token, body});

                        if (response.status === 401 || response.status === 403) {
                            window.location.href = loginUrl;
                            return;
                        }

                        if (!response.ok || !data || data.success !== true) {
                            setAjaxMessage(commentMsg, (data && data.error) ? data.error : 'Չհաջողվեց ավելացնել մեկնաբանությունը։', 'error');
                            return;
                        }

                        const c = data.comment;
                        if (c && commentsList) {
                            const empty = document.getElementById('noComments');
                            if (empty) empty.remove();

                            const wrapper = document.createElement('div');
                            wrapper.className = 'bg-gray-50 border rounded-2xl p-5';

                            const header = document.createElement('div');
                            header.className = 'flex items-center justify-between';

                            const name = document.createElement('div');
                            name.className = 'font-bold text-gray-900 text-sm';
                            name.textContent = c.userName || 'User';

                            const time = document.createElement('div');
                            time.className = 'text-xs text-gray-400';
                            time.textContent = c.createdAt || '';

                            header.appendChild(name);
                            header.appendChild(time);

                            const bodyEl = document.createElement('div');
                            bodyEl.className = 'text-sm text-gray-700 mt-2 whitespace-pre-line';
                            bodyEl.textContent = c.body || '';

                            wrapper.appendChild(header);
                            wrapper.appendChild(bodyEl);

                            commentsList.prepend(wrapper);
                        }

                        if (commentBody) commentBody.value = '';
                        setTimeout(() => setAjaxMessage(commentMsg, '', 'success'), 1500);
                    } catch (err) {
                        setAjaxMessage(commentMsg, 'Համակարգային սխալ։', 'error');
                    } finally {
                        if (commentSubmit) commentSubmit.disabled = false;
                    }
                });
            }
        })();
    </script>
{% endblock %}


