{% extends '@EasyAdmin/page/content.html.twig' %}

{% set role = dashboard.role|default('unknown') %}

{% set statusMeta = {
  'PENDING':   {'label': 'Սպասման մեջ', 'badgeClass': 'badge badge-warning rounded-pill'},
  'CONFIRMED': {'label': 'Հաստատված',   'badgeClass': 'badge badge-success rounded-pill'},
  'COMPLETED': {'label': 'Ավարտված',    'badgeClass': 'badge badge-info rounded-pill'},
  'CANCELED':  {'label': 'Չեղարկված',   'badgeClass': 'badge badge-danger rounded-pill'}
} %}

{% block content_title %}
    {% if role == 'admin' %}
        Ադմին վահանակ
    {% elseif role == 'artist' %}
        Իմ վահանակը
    {% else %}
        Վահանակ
    {% endif %}
{% endblock %}

{% block main %}
    {% if role == 'artist' and dashboard.missingProfile|default(false) %}
        <div class="alert alert-warning">
            Ձեր վարպետի պրոֆիլը դեռ չկա։ Խնդրում ենք կապ հաստատել ադմինի հետ, որ ստեղծեն `ArtistProfile`։
        </div>
    {% else %}
    <div class="ango-dashboard">
    {% if role == 'admin' %}
        {% set usersUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\UserCrudController').setAction('index').generateUrl() %}
        {% set artistsUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\ArtistProfileCrudController').setAction('index').generateUrl() %}
        {% set categoriesUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\ServiceCategoryCrudController').setAction('index').generateUrl() %}
        {% set servicesUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\ServiceCrudController').setAction('index').generateUrl() %}
        {% set appointmentsUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\AppointmentCrudController').setAction('index').generateUrl() %}
        {% set postsUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\ArtistPostCrudController').setAction('index').generateUrl() %}

        <div class="row g-3">
            <div class="col-12 col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">Օգտատերեր</div>
                        <div class="h3 mb-0">{{ dashboard.counts.users|default(0)|number_format(0, '.', ' ') }}</div>
                        <a href="{{ usersUrl }}" class="stretched-link" aria-label="Բացել՝ Օգտատերեր">
                            <span class="visually-hidden">Բացել</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">Վարպետներ</div>
                        <div class="h3 mb-0">{{ dashboard.counts.artists|default(0)|number_format(0, '.', ' ') }}</div>
                        <a href="{{ artistsUrl }}" class="stretched-link" aria-label="Բացել՝ Վարպետներ">
                            <span class="visually-hidden">Բացել</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">Կատեգորիաներ</div>
                        <div class="h3 mb-0">{{ dashboard.counts.serviceCategories|default(0)|number_format(0, '.', ' ') }}</div>
                        <a href="{{ categoriesUrl }}" class="stretched-link" aria-label="Բացել՝ Կատեգորիաներ">
                            <span class="visually-hidden">Բացել</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">Ծառայություններ</div>
                        <div class="h3 mb-0">{{ dashboard.counts.services|default(0)|number_format(0, '.', ' ') }}</div>
                        <a href="{{ servicesUrl }}" class="stretched-link" aria-label="Բացել՝ Ծառայություններ">
                            <span class="visually-hidden">Բացել</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="h5 mb-3">Ամրագրումներ</h2>
            <div class="row g-3">
                {% for k, meta in statusMeta %}
                    <div class="col-12 col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="text-muted">{{ meta.label }}</div>
                                    <span class="{{ meta.badgeClass }}">{{ k }}</span>
                                </div>
                                <div class="h3 mb-0">{{ dashboard.appointments.byStatus[k]|default(0)|number_format(0, '.', ' ') }}</div>
                                <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Ամրագրումներ — {{ meta.label }}">
                                    <span class="visually-hidden">Բացել</span>
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Այսօր</div>
                            <div class="h3 mb-0">{{ dashboard.appointments.today|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Ամրագրումներ — Այսօր">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Հաջորդ 7 օր</div>
                            <div class="h3 mb-0">{{ dashboard.appointments.upcoming7|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Ամրագրումներ — Հաջորդ 7 օր">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Ընդհանուր</div>
                            <div class="h3 mb-0">{{ dashboard.appointments.total|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Ամրագրումներ — Ընդհանուր">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="h5 mb-3">Եկամուտ (մոտավոր)</h2>
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Այսօր (ավարտված)</div>
                            <div class="h3 mb-0">{{ dashboard.revenue.todayCompleted|default(0)|number_format(0, '.', ' ') }} AMD</div>
                            <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Ամրագրումներ — Այսօր (ավարտված)">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Այս ամիս (ավարտված)</div>
                            <div class="h3 mb-0">{{ dashboard.revenue.thisMonthCompleted|default(0)|number_format(0, '.', ' ') }} AMD</div>
                            <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Ամրագրումներ — Այս ամիս (ավարտված)">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="h5 mb-3">Բլոգ</h2>
            <div class="row g-3">
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Published posts</div>
                            <div class="h3 mb-0">{{ dashboard.blog.publishedPosts|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Published posts">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Draft posts</div>
                            <div class="h3 mb-0">{{ dashboard.blog.draftPosts|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Draft posts">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Comments (7 օր)</div>
                            <div class="h3 mb-0">{{ dashboard.blog.commentsLast7Days|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Posts">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Ratings (7 օր)</div>
                            <div class="h3 mb-0">{{ dashboard.blog.ratingsLast7Days|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Posts">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="h5 mb-3">Մոտակա ամրագրումներ</h2>
            {% if dashboard.appointments.upcomingList is empty %}
                <div class="alert alert-light mb-0">Մոտակա ամրագրումներ չկան։</div>
            {% else %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Ամսաթիվ</th>
                            <th>Հաճախորդ</th>
                            <th>Ծառայություն</th>
                            <th>Վարպետ</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for a in dashboard.appointments.upcomingList %}
                            {% set editUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\AppointmentCrudController').setAction('edit').setEntityId(a.id).generateUrl() %}
                            <tr>
                                <td><a href="{{ editUrl }}">{{ a.startDatetime|date('Y-m-d H:i') }}</a></td>
                                <td>{{ a.clientName }}</td>
                                <td>{{ a.service.name }}</td>
                                <td>{{ a.artist.user.firstName }} {{ a.artist.user.lastName }}</td>
                                {% set meta = statusMeta[a.status]|default({'label': a.status, 'badgeClass': 'badge badge-secondary rounded-pill'}) %}
                                <td><span class="{{ meta.badgeClass }}">{{ a.status }}</span></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    {% elseif role == 'artist' %}
        {% set appointmentsUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\AppointmentCrudController').setAction('index').generateUrl() %}
        {% set myProfileUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\ArtistProfileCrudController').setAction('index').generateUrl() %}
        {% set postsUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\ArtistPostCrudController').setAction('index').generateUrl() %}

        <div class="row g-3">
            <div class="col-12 col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">Իմ rating-ը</div>
                        <div class="h3 mb-0">
                            {{ (dashboard.artist.ratingAvg|default(0))|number_format(2, '.', ' ') }}
                            <span class="text-muted small">({{ dashboard.artist.ratingCount|default(0)|number_format(0, '.', ' ') }})</span>
                        </div>
                        <a href="{{ myProfileUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ պրոֆիլը">
                            <span class="visually-hidden">Բացել</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">Իմ ամրագրումները</div>
                        <div class="h3 mb-0">{{ dashboard.appointments.total|default(0)|number_format(0, '.', ' ') }}</div>
                        <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ ամրագրումները">
                            <span class="visually-hidden">Բացել</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">Այս ամիս եկամուտ (ավարտված)</div>
                        <div class="h3 mb-0">{{ dashboard.revenue.thisMonthCompleted|default(0)|number_format(0, '.', ' ') }} AMD</div>
                        <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ ամրագրումները — Այս ամիս եկամուտ (ավարտված)">
                            <span class="visually-hidden">Բացել</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="h5 mb-3">Իմ ամրագրումների վիճակագրություն</h2>
            <div class="row g-3">
                {% for k, meta in statusMeta %}
                    <div class="col-12 col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="text-muted">{{ meta.label }}</div>
                                    <span class="{{ meta.badgeClass }}">{{ k }}</span>
                                </div>
                                <div class="h3 mb-0">{{ dashboard.appointments.byStatus[k]|default(0)|number_format(0, '.', ' ') }}</div>
                                <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ ամրագրումները — {{ meta.label }}">
                                    <span class="visually-hidden">Բացել</span>
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Այսօր</div>
                            <div class="h3 mb-0">{{ dashboard.appointments.today|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ ամրագրումները — Այսօր">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Հաջորդ 7 օր</div>
                            <div class="h3 mb-0">{{ dashboard.appointments.upcoming7|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ appointmentsUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ ամրագրումները — Հաջորդ 7 օր">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="h5 mb-3">Իմ բլոգը</h2>
            <div class="row g-3">
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Published posts</div>
                            <div class="h3 mb-0">{{ dashboard.blog.publishedPosts|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ posts — Published">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Draft posts</div>
                            <div class="h3 mb-0">{{ dashboard.blog.draftPosts|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Իմ posts — Draft">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Comments (7 օր)</div>
                            <div class="h3 mb-0">{{ dashboard.blog.commentsLast7Days|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Posts">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="text-muted">Ratings (7 օր)</div>
                            <div class="h3 mb-0">{{ dashboard.blog.ratingsLast7Days|default(0)|number_format(0, '.', ' ') }}</div>
                            <a href="{{ postsUrl }}" class="stretched-link" aria-label="Բացել՝ Posts">
                                <span class="visually-hidden">Բացել</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            {% if dashboard.blog.topPosts|default([]) is not empty %}
                <div class="mt-3 table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Post</th>
                            <th>Avg rating</th>
                            <th>Count</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in dashboard.blog.topPosts %}
                            {% set p = row.post %}
                            <tr>
                                <td>{{ p.title }}</td>
                                <td>{{ (row.avgRating|default(0))|number_format(2, '.', ' ') }}</td>
                                <td>{{ row.ratingCount|default(0)|number_format(0, '.', ' ') }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>

        <div class="mt-4">
            <h2 class="h5 mb-3">Մոտակա ամրագրումներ</h2>
            {% if dashboard.appointments.upcomingList is empty %}
                <div class="alert alert-light mb-0">Մոտակա ամրագրումներ չկան։</div>
            {% else %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Ամսաթիվ</th>
                            <th>Հաճախորդ</th>
                            <th>Ծառայություն</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for a in dashboard.appointments.upcomingList %}
                            {% set editUrl = ea_url().unsetAll().setController('App\\Controller\\Admin\\AppointmentCrudController').setAction('edit').setEntityId(a.id).generateUrl() %}
                            <tr>
                                <td><a href="{{ editUrl }}">{{ a.startDatetime|date('Y-m-d H:i') }}</a></td>
                                <td>{{ a.clientName }}</td>
                                <td>{{ a.service.name }}</td>
                                {% set meta = statusMeta[a.status]|default({'label': a.status, 'badgeClass': 'badge badge-secondary rounded-pill'}) %}
                                <td><span class="{{ meta.badgeClass }}">{{ a.status }}</span></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="alert alert-info">
            Այստեղ շուտով կլինեն վիճակագրական տվյալներ։
        </div>
    {% endif %}
    </div>
    {% endif %}
{% endblock %}
